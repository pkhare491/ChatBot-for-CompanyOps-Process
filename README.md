from difflib import SequenceMatcher

def similar(a, b):
    return SequenceMatcher(None, a, b).ratio()

# Dictionary to store questions and answers
knowledge_base = {
    "Hi": "Hello! How can I help you today?",
    "Hello": "Hello! How can I help you today?",
    "Who is the process owner": "The process owner is Mithun Muni.",
    #--
    "What is the process purpose": '''The purpose of the process is to ensure that all the relevant operation data
    pertaining to the companys basic information, which includes local name, headquarter address, registered 
    address, industry classification, business descriptions, advisers, subsidiaries and products, are captured in 
    a uniform, correct and efficient ma nner for client delivery. The data collection team gathers this information
    from a variety of documents including 10 K, 20 F 40 F and Annual Report (of English language) which are filed 
    annually by the companies, providing the most comprehensive dataset. The timeliness and completeness of data 
    collection affects Morningstars internal as well as external clients''',
    #--
    
    #--
    "Who approves the process": "The process is approved by Himanshu Sadana",
    #--
    "What are the key steps in the process": "The key steps are Define, Execute, and Monitor.",
    #--
    "What is Process Background" : "Company Operations process was started in February 2010. The Company Operations team collects basic operational data of equity companies for Morningstars global equity coverage. The team maintains data points such as a local name, headquarter address, registered address, business descriptions, subsidiaries, products and other operational information such as established date, fiscal year end, REIT, limited partner (LP), shell company, operational status, limited liability company (LLC), business development company (BDC), master limited partnership (MLP) and special purpose acquisition company (SPAC). The process also includes classification of companies into different industries and sectors as per Morningstar’s Global Equity Classification Structure. The total coverage stands at roughly 57,000 companies. Other than English, business descriptions are created in German, Spanish and Portuguese languages. The Descriptions for Chinese traditional and simplified are covered by the Shenzhen team.",
    #--
    "What are process objectives" : """Accuracy: The data analyst ensures that the relevant data points provided in a given filing are accurately updated in the database. The final data should match the facts and figures provided by the company (quality threshold 98%).
    Completeness: The term completeness refers to information captured by the data analysts, ensuring that all the relevant data points are derived and are assertive to the context provided in the Annual Report document.
    Note: Accuracy and Completeness are measured by checking the reviewed files on a daily basis using appropriate tools and processes.""",
    #--
    "Customers" : '''Internal Customers:
    Morningstar.com;
    Morningstar Direct

    External Customers:
    Microsoft;
    TMX;
    OMX;
    Euronext;
    Various clients through data feeds''',
    #--
    "Stakeholders" : "Frannie Besztery, Kamlendra Shekhawat , Rikta Dey Kundu and Company Ops Team",
    #--
    "What is local name" : '''Local Name is the name of a company in its native language (as it appears on the stock exchange). The Local Name should be associated with the preset language codes from the application.
    Note: If Local Name for any company is more than 75 characters. It can’t be parsed/flow in EXOI''',
    #--
    "Translated Name": '''Translated Name is the actual English name of the company as per the Exchange. It is the name which is generated by the GID team with the unique company ID, when creating the New Companies or when the company’s name has been changed.''',
    #--
    "Short Name" : "It is the name taken from the Translated Name with the limitation of 25 characters.",
    #--
    "Domicile Country": '''While creating the Company and Company ID, the GID team also updates the domicile country of the company. It is the country where the company has been registered. This filed is populated from GID application.''',
    #--
    "Place of Incorp." : '''Incorporation specifies creation place of a corporation. For U.S. companies, place of incorporation is the state, where the company is/was created. However, for International companies the place of incorporation is the name of the country.''',
    #--
   "Headquarters" : '''Headquarters section consists of address, phone & fax number, web address and E-mail. Headquarters (HQ) denotes the location where most, if not all, of the important functions of an organization are coordinated.
For updating Headquarters section, a DA must first check the latest available Reports (annual, interim & quarterly reports). However, while updating the address there are few things to be remembered.
Firstly, refer AR for Headquarter address. If it is mentioned as Registered Office in AR, then check Company's website if it has the same address. If the address in AR and website are same then update it as headquarter address. In case, if there is a different address in website stating as Head Office then a DA has to update the Head Office address from the website as Headquarter address and Vise-Versa.
Source of headquarter address:
1)Annual Report
2)Website
3)Stock Exchange
Note : The head office addresses of Canadian companies must be updated from Sedar’s main page only.''',
    #--
    "Web Address" : '''Source for checking web address for the company:
o Annual Report
o Exchange
o Google Search''',
#--
"Rules for updating the head office address, where there are 2 different head offices" : '''
Illustrated with an example -
Case 1 - The registered office is of Hyderabad and Head offices are of Mumbai and Hyderabad, where Mumbai has only the address and Hyderabad has the address and the contact details. In such a case, we must consider the head office which consists of contact details and the address, i.e Hyderabad.
Case 2 - The registered office is of Hyderabad and the contact details of both Mumbais head office and Hyderabads heads office are available. In such a case, we must consider Hyderabads head office because the registered office is in Hyderabad.
Case 3 - In case the registered office and the two head offices are of different locations, i.e registered office is of Hyderabad and the head offices are in Mumbai and Rajasthan, we can take any of the two as our head office.''',
#--
"Industry Codes" : 
'''
Industry Code section consist of seven types of classification based on the domicile country of the company. The principal aim to categorize companies into subsectors is based primarily on a company's nature of business or operations, source of revenue or where it constitutes the majority of revenue.
The equity Data Analyst will select the correct Morningstar Industry Code based on the company's nature of business either from an annual, interim or quarterly report, which can be located in the business section or nature of operations in the reporting. Company's nature of business can also be found in the profile page or about us section of the companys website. This business description should be matched against the Morningstar Industry Group descriptions for proper industry classification code assignment.
Seven different type of Industry codes are
1. Mstar Global
2. NACE
3. ISIC
4. USA-SIC
5. NAICS
6. CAN-SIC
7. CAN-NAICS
The first three classifications are mandatory for all the companies irrespective of the domicile of the company. And for USA and Canadian company all the seven classifications are mandatory.
Document for Industry Classification can be accessed from:
Industry_codes\MorningstarGlobalEquityClassStructure_Oct_2019.pdf
''',
#--
"Employee Information" : '''
This section provides the detail of full time, part time and aggregate number of employees in the organization on the specific date.
DA will update the emoloyee details for all the P1-P7 companies.
If the DA is adding employee information, he will need to click on the “Create” button and after completing the information click again on the “Create button”. If he/she is simply changing an old record, he will simply select the text box of the desired data point (e.g.. Full Time), and enter the change.
 As of Date: It is a date, when the company has reported its employee detail date. “As of Date” won’t necessarily be the same as the filing date. It can be either the filing date or fiscal year date. Many times, when giving an employee number, the company will state as: As of March 10, 2014 we had 212 Full time and 121 part time employees.
 Full-time: It is employment in which a person works a minimum number of hours defined as such by his/her employer. Full-time employment often comes with benefits that are not typically offered to part-time, temporary, or flexible workers, such as annual leave, sick leave, and health insurance.
 Part Time: It is a form of employment that carries fewer hours per week than a full-time job. Workers are considered to be part-time if they commonly work fewer than 30 or 35 hours per week.
 Total:It is a consolidation of Full and Part Time employees.
Below are the seven principles for updating employee information:
i. Regardless the ‘identification’ of partner/contractors/consultants/representatives/agents, or director/officer, if they contribute to the Revenue, is the essential part of the ordinary business, then we need to collect them as employee number. The ratio we use employee number for calculation are Total Revenue per employee, Net Income per Employee. So any staff or people who are the essential part to run daily business to generate the revenue/Net income of main business, need to count as employee number.
ii. Should collect consolidated employee number rather than partial ones, adding up employees of all subsidiaries/locations/segments, etc.
iii. If the company only reports average employee of a period, we should collect it as employee. When full time is average number, we should mark the average flag. If both employee as of a specific date and average number of a period reported, we should collect employee as of a specific date as higher priority.
iv. As full time or part time employment is generally determined by the employer, when we collect the employee number data, we will conform to the company’s disclosure. If the company reports the employee number ambiguously and we cannot tell apart the full time and part time number, then collect the number as full time employee number.
v. Collect employee number for the current fiscal period instead of historical period’s. If company report employee components as of different dates under the same period, add up these separate date’s employee number to this company’s total employee number.
vi. If the company uses ambiguous words such as “less than”, “more than”, or “approximately” to report employee number data, we should collect the employee number data.
vii. If there is not sufficient employee number information reported, leave it as null. However, if the company reports the exact number (including 0) or the information which we can count out number, we will collect the employee number data accordingly.
Note: We do not update Directors under employee counts.''',
#--
"What things can be included in full time employees": '''
Full time hourly employee
Full time equivalent
Contract employees
Regular employees
Salaried employees
''',
#--
"What things can be included in Part time employees" : '''
Hourly employee
Part time hourly employee
Temporary employees
Fixed-term employee
Seasonal person
''' ,
#--
"Established Date" : '''
Established date is the incorporation date of the company. This dated is update in mm/dd/yyyy format, as reported in the file or if only the year is mentioned then it is updated as 01/01//2012. Established date often precedes the IPO Date.
If a DA comes across an instance where a Company is originally incorporated in a particular year and then reincorporated in other year in such case we will consider the first date as Incorporation date.
While updating Established Date, firstly search of incorporation date and if unable to find then check for registration date then inception date then established date and then for founded date. Incorporation – Registration - Inception - Established – Founded.

Source of Establishment / Incorporation Date:
o Annual Report
o Company Website
o Stock Exchange.

Note:- We have a character limit of 50 character in EXOI for website.''',

"Fiscal Year End" : '''
Fiscal year is updated in mm/dd/yyyyy format. Fiscal Year End represents the next financial year end for a company’s accounting period and should be confirmed from the cover page of a company report. The company’s website should only be considered as a secondary source.

Now, Company Ops team would not update FYE in the application, except for below cases:
1. Update FYE for all the New Companies.
2. While processing any company through any document, if FYE is blank, DA needs to update as per that document.
3. DA is not supposed to forward FYE while processing Annual Report document, but as this is a new enhancement, DA needs to keep a check whether the FYE for the particular company is forwarded or not. In case it is not forwarded, then the DA needs to inform the admin.''',
#--
"REIT" : '''
REIT stands for Real Estate Investment Trust and operates like an investment trust. It is a quoted company that owns and manages income-producing property, either commercial or residential and is designed to offer investors income and capital growth from rented property assets. It is a security that sells like a stock on the major exchanges and invests in real estate directly, either through properties or mortgages. REITs receive special tax considerations and typically offer investors high yields, as well as a highly liquid method of investing in real estate.
The DA must mark whether the company is a Real Estate Investment Trust, which is like a real estate holding company, almost always designated by the suffix, “Trust”. This information can be found either in a regulatory filing or on the company’s website or on stock exchange.''',
#--
"Limited Partnership" : '''
Two or more partners united to conduct a business jointly, and in which one or more of the partners is liable only to the extent of the amount of money that partner has invested. Limited partners do not receive dividends, but enjoy direct access to the flow of income and expenses. The DA must mark whether the company is a Limited Partnership or not, and just like REITs, the DA should check the regulatory filings first, and then the company’s website.
To check, if the company is a limited partner or not, a DA has to refer to form S-1/S-4 (Exhibit 3.01).''',
#--
"Limited Partnership Company" : '''
Certificate of Limited Partnership of the Registrant EX-3.01
Certificate of Limited Partnership EX-3.1''',
#--
"Non- Limited Partnership Company" : '''
Either you will get the form like the below one, or you will not get the form:
Certificate OF Formation of Apollo Global Management, LLCEX-3.1
Certificate OF Formation OF PPL Energy SupplyEX-3.1''',
#--
"What is SPAC?" : '''
A special purpose acquisition company (SPAC) is formed for the purpose of raising capital through an IPO and using those funds to acquire an operating business.

Coverage:
All market
Keywords:
1) Special purpose acquisition company
2) Special Purpose vehicle
3) SPAC
''',
#--
"What is an MLP?" : '''
MLP is a partnership that is publicly traded and listed on a national securities exchange. MLP are focused on exploration, development, mining, processing, or transportation of minerals or natural resources. MLPs hold cash-generating assets such as oil and gas properties or pipelines.
Criteria to become an MLP:
To form a MLP or to get it as a pass, 90% of its income needs to be qualifying income. That is, 90% of the income should come from natural resources, commodities and real estate.

Note: Most MLPs currently operate in the energy industry. An energy master limited partnership (EMLP) will typically provide and manage resources for other existing energy-based businesses.
Examples include firms that provide pipeline transportation, refinery services, and supply and logistics support services for oil companies.

Keywords:
1) We are a growth-oriented master limited partnership
2) We are a fee-based, growth-oriented, Delaware master limited partnership
3) PAA is a publicly traded master limited partnership

Coverage:
1) USA

Companies in our database:
1) 0C0000AX3N - Green Plains Partners LP
''',
#--
"What is business development company?" : 
'''
Business development companies (BDCs) are special investment vehicles designed to facilitate capital formation for small and middle-market companies.

Keywords:
1) specialty finance company
2) closed-end investment company
3) unregistered closed-end investment company
4) Regulated Investment company (RIC's)
5) BDC
6) 90% of the taxable income should be distributed as to shareholders

Note: We have elected to be regulated as a business development company (“BDC”) under the Investment Company Act of 1940, as amended and the rules and regulations promulgated thereunder, the “Investment Company Act.”

Companies in our database:
1) 0C00000Q0X BlackRock Capital Investment Corp
2) 0C0000A4CX Harvest Capital Credit Corp
''',
#--
"Registered Office" :
'''
A registered office is the official address of an incorporated company, association or any other legal entity. Generally it will form part of the public record and is required in most countries where the registered organization or legal entity is incorporated. A registered physical office address is required for incorporated organizations to receive official correspondence and formal notices from government departments, investors, banks, shareholders and the general public.
In some cases mostly (Canadian) the companies state “Registered Head Office”. In such a case the DA needs to update that address in both Headquarters and Registered Office.
''',
#--
"Business Description" : 
'''
The Business Description of the company is a concise description of a business. It provides information like business activities, major segments or divisions, products, major source of revenue and geographical areas of operation.

The business description page consists of:
1) English Language Profile
2) Local Language Profile

The Business Description of the company is updated in English language and the Local Language Profile, if any. This tab contains 2 profiles (1 English Language Profile, and 1 Local Language Profile).
The profile is character specific. The DA has the option either to modify or delete an existing profile or add a completely new profile.

A. Long Profile
Long Profile (Smart Description) should provide an independent, straightforward, plain-language overview of a company’s core business activities. The profile should help the reader determine whether to investigate further or move on to another company. Describing how and where the company “makes money” should help achieve this objective. The character should be approximately between 500-800 characters.

Aim to include the following information:
1) Information on key segments
2) Major products or brands
3) Geographic information related to sales and operations
4) Describe how the company generates revenue
''',
#--
"Types of adviser" : 
'''
o Auditor
o Registrar
o Stockbroker
o Nominated Adviser
o Financial Adviser
o Bank
o Financial PR Adviser
o Remuneration Consultant
o Solicitor
''',
    "What is short name for Acquisition": "Acq",
    "What is short name for Advanced": "Adv",
    "What is short name for Alternative": "Alt",
    "What is short name for Associated": "Assoc",
    "What is short name for Building": "Bldg",
    "What is short name for Business": "Bus",
    "What is short name for Capital": "Cap",
    "What is short name for Capital Trust": "CT",
    "What is short name for Commercial": "Comml",
    "What is short name for Communications": "Comms",
    "What is short name for Companies": "Cos",
    "What is short name for Company": "Co",
    "What is short name for Consolidated": "Cons",
    "What is short name for Construction": "Const",
    "What is short name for Corporation": "Corp",
    "What is short name for Development": "Dev",
    "What is short name for Distribution": "Dist",
    "What is short name for Dividend & Growth": "Div & Gwth",
    "What is short name for Electronic": "Elect",
    "What is short name for Engineering": "Eng",
    "What is short name for Environmental": "Envirn",
    "What is short name for European": "Euro",
    "What is short name for Exploration": "Explr",
    "What is short name for Finance & Investment": "Fin & Inv",
    "What is short name for Financial": "Finl",
    "What is short name for Fund": "Fd",
    "What is short name for General": "Gen",
    "What is short name for Global": "Glb",
    "What is short name for Group": "Gr",
    "What is short name for Growth": "Gwth",
    "What is short name for Growth & Income": "G&I",
    "What is short name for Growth & Income Trust": "G&IT",
    "What is short name for Holdings": "Hldgs",
    "What is short name for Income": "Inc",
    "What is short name for Income & Growth": "I&G",
    "What is short name for Income & Growth Trust": "I&GT",
    "What is short name for Income Trust": "IT",
    "What is short name for Industrial": "Ind",
    "What is short name for Industries": "Indus",
    "What is short name for Information": "Info",
    "What is short name for Infrastructure": "Infr",
    "What is short name for Institutional": "Instl",
    "What is short name for International": "Intl",
    "What is short name for Investment Trust": "IT",
    "What is short name for Investments": "Inv",
    "What is short name for Investors": "Invts",
    "What is short name for Management": "Mgmt",
    "What is short name for Manufacturing": "Mfg",
    "What is short name for Market": "Mkt",
    "What is short name for Materials": "Mat",
    "What is short name for National": "Ntl",
    "What is short name for Opportunities": "Opps",
    "What is short name for Opportunity": "Opp",
    "What is short name for Perpetual": "Perp",
    "What is short name for Petroleum": "Ptrl",
    "What is short name for Pharmaceuticals": "Pharma",
    "What is short name for Portfolio": "Pf",
    "What is short name for Private": "Pvt",
    "What is short name for Products": "Prods",
    "What is short name for Properties": "Props",
    "What is short name for Property": "Prop",
    "What is short name for Real Estate": "Real Est",
    "What is short name for Resource": "Res",
    "What is short name for Securities": "Secs",
    "What is short name for Securities & General": "Secs & Gen",
    "What is short name for Services": "Servs",
    "What is short name for Smaller": "Smr",
    "What is short name for Solutions": "Solns",
    "What is short name for Strategies": "Strat",
    "What is short name for Structured": "Str",
    "What is short name for Systems": "Sys",
    "What is short name for Technologies": "Techs",
    "What is short name for Technology": "Tech",
    "What is short name for Telecommunications": "Telecom",
    "What is short name for Trust": "Tr",
    "What is short name for Venture": "Ven",
    "What is short name for Venture Capital Trust": "VCT"
,
# --  
"Business Country" : '''Business Country is a vital data point and is used throughout Morningstar’s products and methodology. Business Country specifies the principal business location of the company.''',
     # Add more question-answer pairs here
}

threshold = 0.7  # Set similarity threshold

print("🤖 Hello! I am your process assistant chatbot. Ask me anything about the process!")

# List of tax haven countries
tax_haven_countries = [
    "aland islands", "anguilla", "bermuda", "bonaire, sint eustatius and saba", "bouvet island",
    "cayman islands", "channel islands", "christmas island", "cocos (keeling) islands", "curacao",
    "falkland islands", "faroe islands", "gibraltar", "guernsey", "heard island and mcdonald islands",
    "isle of man", "jersey", "marshall islands", "netherlands antilles", "norfolk island",
    "northern mariana islands", "south georgia and the south sandwich islands", "turks and caicos islands",
    "united states minor outlying islands", "virgin islands, british", "virgin islands, u.s.",
    "sint maarten", "monaco", "montserrat", "puerto rico", "saint barthelemy", "saint kitts and nevis",
    "saint martin", "st. lucia"
]

# Mapping of tax haven countries to their controlling countries
controlling_countries = {
    "aland islands": "finland", "anguilla": "uk", "bermuda": "uk", "bonaire, sint eustatius and saba": "netherlands",
    "bouvet island": "norway", "cayman islands": "uk", "channel islands": "united kingdom", "christmas island": "australia",
    "cocos (keeling) islands": "australia", "curacao": "netherlands", "falkland islands": "uk", "faroe islands": "denmark",
    "gibraltar": "uk", "guernsey": "uk", "heard island and mcdonald islands": "australia", "isle of man": "uk",
    "jersey": "uk", "marshall islands": "usa", "netherlands antilles": "netherlands", "norfolk island": "australia",
    "northern mariana islands": "usa", "south georgia and the south sandwich islands": "uk", "turks and caicos islands": "uk",
    "united states minor outlying islands": "usa", "virgin islands, british": "uk", "virgin islands, u.s.": "usa",
    "sint maarten": "netherlands", "monaco": "france", "montserrat": "uk", "puerto rico": "usa", "saint barthelemy": "france",
    "saint kitts and nevis": "uk", "saint martin": "france", "st. lucia": "united kingdom"
}

def ask_business_country_questions():
    domicile = input("What is the domicile country? ").strip().lower()
    listing = input("What is the listing country? ").strip().lower()
    hq = input("What is the headquarters country? ").strip().lower()

    # Check consistency among the three factors
    if domicile == listing == hq:
        business_country = domicile
    else:
        geographical_revenue = input("Is there a geographical revenue country? (Yes/No): ").strip().lower()
        if geographical_revenue == 'yes':
            revenue_country = input("What is the geographical revenue country? ").strip().lower()
            business_country = revenue_country
        else:
            business_country = hq

    # Check if the determined business country is a tax haven
    if business_country in tax_haven_countries:
        if hq not in tax_haven_countries:
            business_country = hq
        elif listing not in tax_haven_countries:
            business_country = listing
        elif domicile not in tax_haven_countries:
            business_country = domicile
        else:
            # All three factors are tax havens, use the controlling country
            business_country = controlling_countries.get(business_country, business_country)

    print(f"Your business country is {business_country.capitalize()}.")



while True:
    user_question = input("You: ").strip()

    if user_question.lower() in ["exit", "quit", "bye"]:
        print("🤖 Goodbye! Feel free to ask me anytime. 😊")
        break

    best_match = None
    highest_similarity = 0

    for condition, response in knowledge_base.items():
        similarity = similar(user_question.lower(), condition.lower())
        if similarity > highest_similarity and similarity >= threshold:
            highest_similarity = similarity
            best_match = response


    if best_match:
        print(f"🤖 {best_match}")
  
        if "business country" in user_question.lower():
            ask_business_country_questions()
    else:
        print("🤖 I'm sorry, I didn't quite understand that. Could you please rephrase?")
